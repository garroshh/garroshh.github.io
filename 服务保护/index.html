<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>服务保护 - LoveIt</title><meta name=Description content="关于 LoveIt 主题"><meta property="og:title" content="服务保护"><meta property="og:description" content="Istio 的安全功能十分强大，安全场景包括对网关的加密、服务间的访问控制、认证和授权。网关加密由 Ingress Gateway 实现，访问控制依赖 Mixer，认证和授权主要由 C"><meta property="og:type" content="article"><meta property="og:url" content="https://garroshh.me/%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/"><meta property="og:image" content="https://garroshh.me/logo.png"><meta property="article:published_time" content="2020-05-14T11:17:30+08:00"><meta property="article:modified_time" content="2020-05-14T11:17:30+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://garroshh.me/logo.png"><meta name=twitter:title content="服务保护"><meta name=twitter:description content="Istio 的安全功能十分强大，安全场景包括对网关的加密、服务间的访问控制、认证和授权。网关加密由 Ingress Gateway 实现，访问控制依赖 Mixer，认证和授权主要由 C"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://garroshh.me/%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/><link rel=prev href=https://garroshh.me/%E8%87%AA%E5%8A%A8%E5%8C%96%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/><link rel=next href=https://garroshh.me/%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"服务保护","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/garroshh.me\/%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4\/"},"image":{"@type":"ImageObject","url":"https:\/\/garroshh.me\/cover.png","width":800,"height":600},"genre":"posts","keywords":"Istio, 实验","wordcount":3057,"url":"https:\/\/garroshh.me\/%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4\/","datePublished":"2020-05-14T11:17:30+08:00","dateModified":"2020-05-14T11:17:30+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/garroshh.me\/logo.png","width":127,"height":40}},"author":{"@type":"Person","name":"garroshh"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=LoveIt><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/categories/documentation/>文档 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/dillonzq/LoveIt title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value;"><option value=/%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/ selected>简体中文</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=LoveIt><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>所有文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/categories/documentation/>文档</a><a class=menu-item href=/about/>关于</a><a class=menu-item href=https://github.com/dillonzq/LoveIt title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value;"><option value=/%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">服务保护</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=garroshh.me title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>garroshh</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/istio/><i class="far fa-folder fa-fw"></i>Istio</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-05-14>2020-05-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3057 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 7 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#11-单向-tls-网关>1.1. 单向 TLS 网关</a><ul><li><a href=#111-实验目标>1.1.1. 实验目标</a></li><li><a href=#112-实验演练>1.1.2. 实验演练</a></li></ul></li><li><a href=#12-双向-tls-网关>1.2. 双向 TLS 网关</a><ul><li><a href=#121-实验目标>1.2.1. 实验目标</a></li><li><a href=#122-实验演练>1.2.2. 实验演练</a></li></ul></li><li><a href=#13-sds-加密网关>1.3. SDS 加密网关</a><ul><li><a href=#131-实验目标>1.3.1. 实验目标</a></li><li><a href=#132-实验演练>1.3.2. 实验演练</a></li></ul></li></ul><ul><li><a href=#21-黑名单>2.1. 黑名单</a><ul><li><a href=#211-实验目标>2.1.1. 实验目标</a></li><li><a href=#212-实验演练>2.1.2. 实验演练</a></li></ul></li><li><a href=#22-白名单>2.2. 白名单</a><ul><li><a href=#221-实验目标>2.2.1. 实验目标</a></li><li><a href=#222-实验演练>2.2.2. 实验演练</a></li></ul></li></ul><ul><li><a href=#31-实验目标>3.1. 实验目标</a></li><li><a href=#32-实验演练>3.2. 实验演练</a></li></ul><ul><li><a href=#41-命名空间级别的访问控制>4.1. 命名空间级别的访问控制</a><ul><li><a href=#411-实验目标>4.1.1. 实验目标</a></li><li><a href=#412-实验演练>4.1.2. 实验演练</a></li></ul></li><li><a href=#42-服务级别的访问控制>4.2. 服务级别的访问控制</a><ul><li><a href=#421-实验目标>4.2.1. 实验目标</a></li><li><a href=#422-实验演练>4.2.2. 实验演练</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>Istio 的安全功能十分强大，安全场景包括对网关的加密、服务间的访问控制、认证和授权。网关加密由 Ingress Gateway 实现，访问控制依赖 Mixer，认证和授权主要由 Citadel、Envoy 实现。</p><h1 id=1-网关加密>1. 网关加密</h1><p>HTTPS 能最大化保证信息传输的安全，是当前互联网推荐的通讯方式。Istio 为 Gateway 提供了 HTTPS 加密支持。</p><h2 id=11-单向-tls-网关>1.1. 单向 TLS 网关</h2><p>一般的 Web 应用都采用单向认证，即仅客户端验证服务端证书，无须在通信层做用户身份验证，而是在应用逻辑层保证</p><p>用户的合法登入。</p><h3 id=111-实验目标>1.1.1. 实验目标</h3><p>在通过 HTTPS 访问 frontend 服务时只校验服务端，而服务端不校验客户端。对 Ingress Gateway 进行配置，为服务启用单向</p><p>TLS 保护，以 HTTPS 的形式对网格外部提供服务。</p><h3 id=112-实验演练>1.1.2. 实验演练</h3><p>（1）使用工具生成客户端与服务端的证书与秘钥：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>git clone https://github.com/nicholasjackson/mtls-go-example.git 
<span class=nb>cd</span> mtls-go-example 
./generate.sh www.weather.com  
mkdir ~/www.weather.com <span class=o>&amp;&amp;</span> mv 1_root/ 2_intermediate/ 3_application/ 4_client/ ~/www.weather.com/
</code></pre></td></tr></table></div></div><p>（2）创建 Secret 对象，用于保存服务器的证书和秘钥：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> ~/www.weather.com 
kubectl create -n istio-system secret tls istio-ingressgateway-certs --key 3_application/private/www.weather.com.key.pem --cert 3_application/certs/www.weather.com.cert.pem
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514111911639.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514111911639.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514111911639.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514111911639.png 2x" data-sizes=auto alt=image-20200514111911639 title=image-20200514111911639></p><p>（3）创建 Gateway 资源：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/gateway-tls-simple.yaml
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112023459.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112023459.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112023459.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112023459.png 2x" data-sizes=auto alt=image-20200514112023459 title=image-20200514112023459></p><p>（4）创建 frontend 服务的 VirtualService 资源：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/vs-frontend-tls.yaml -n weather
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112050914.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112050914.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112050914.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112050914.png 2x" data-sizes=auto alt=image-20200514112050914 title=image-20200514112050914></p><p>可以看到这个 VirtualService 绑定了网关 weather-gateway，在 hosts 中添加了域名信息。外部访问 <a href=http://www.weather.com>www.weather.com</a> 的流量通过 Gateway 被路由到 frontend 的 v1 实例。</p><p>（5）先不使用 CA 证书，直接用 curl 命令向 <a href=http://www.weather.com>www.weather.com</a> 发送 HTTPS 请求，返回结果提示签发证书机构未经认证，无法识别：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>curl -v --resolve www.weather.com:443:10.105.28.142 https://www.weather.com -o /dev/null
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112109562.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112109562.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112109562.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112109562.png 2x" data-sizes=auto alt=image-20200514112109562 title=image-20200514112109562></p><p>使用 CA 证书再次发送 HTTPS 请求，收到成功的响应：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>curl -v --resolve www.weather.com:443:10.105.28.142 --cacert 2_intermediate/certs/ca-chain.cert.pem https://www.weather.com -o /dev/null
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112133767.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112133767.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112133767.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112133767.png 2x" data-sizes=auto alt=image-20200514112133767 title=image-20200514112133767></p><p>如果客户端不想校验服务端，可以使用 -k 或 &ndash;insecure 发送 HTTPS 请求忽略错误。</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112205307.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112205307.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112205307.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112205307.png 2x" data-sizes=auto alt=image-20200514112205307 title=image-20200514112205307></p><h2 id=12-双向-tls-网关>1.2. 双向 TLS 网关</h2><p>双向 TLS 除了需要客户端认证服务端，还增加了服务端对客户端的认证</p><h3 id=121-实验目标>1.2.1. 实验目标</h3><p>通过 HTTPS 访问 frontend 服务时，对服务端和客户端同时进行校验。</p><h3 id=122-实验演练>1.2.2. 实验演练</h3><p>（1）创建一个 Kubernetes Secret，用于存储 CA 证书，服务端会使用这一证书来对客户端进行校验：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> ~/www.weather.com 
kubectl create -n istio-system secret generic istio-ingressgateway-ca-certs --from-file<span class=o>=</span>2_intermediate/certs/ca-chain.cert.pem
</code></pre></td></tr></table></div></div><p>查看配置</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112224986.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112224986.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112224986.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112224986.png 2x" data-sizes=auto alt=image-20200514112224986 title=image-20200514112224986></p><p>（2）创建 Gateway 资源：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/gateway-tls-mutual.yaml
</code></pre></td></tr></table></div></div><p>查看配置：其中 tls 中 mode 字段值为 MUTUAL，并添加了 caCertificates 字段：</p><p>![image-20200514112250771](/Users/jiaheng/Library/Application Support/typora-user-images/image-20200514112250771.png)</p><p>（3）创建 frontend 服务的 VirtualService 资源：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/vs-frontend-tls.yaml -n weather
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112805496.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112805496.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112805496.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112805496.png 2x" data-sizes=auto alt=image-20200514112805496 title=image-20200514112805496></p><p>（4）不使用客户端证书和秘钥发送 HTTPS 请求，客户端校验没有通过：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> ~/www.weather.com curl -v --resolve www.weather.com:443:10.105.28.142 --cacert 2_intermediate/certs/ca-chain.cert.pem https://www.weather.com -o /dev/null
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112740066.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112740066.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112740066.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112740066.png 2x" data-sizes=auto alt=image-20200514112740066 title=image-20200514112740066></p><p>使用客户端证书及秘钥再次发送 HTTPS 请求，校验通过，返回成功：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>curl -v --resolve www.weather.com:443:10.105.28.142 --cacert 2_intermediate/certs/ca-chain.cert.pem --cert 4_client/certs/www.weather.com.cert.pem --key 4_client/private/www.weather.com.key.pem https://www.weather.com -o /dev/null
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112701932.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112701932.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112701932.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112701932.png 2x" data-sizes=auto alt=image-20200514112701932 title=image-20200514112701932></p><h2 id=13-sds-加密网关>1.3. SDS 加密网关</h2><p>引入 Secret 发现服务为 Gateway 提供 HTTPS 的加密支持。</p><h3 id=131-实验目标>1.3.1. 实验目标</h3><p>使用 Secret 发现服务配置入口网关的 TLS，在为主机名 <a href=http://www.weather.cn>www.weather.cn</a> 更新证书和秘钥后，无需重启 Ingress 网关就能自动生效。</p><h3 id=132-实验演练>1.3.2. 实验演练</h3><p>（1）使用 Helm 升级开启 Ingress 网关的 Secret 发现服务：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>helm upgrade istio install/kubernetes/helm/istio -n istio-system --set gateways.istio-ingressgateway.sds.enabled<span class=o>=</span><span class=nb>true</span>
</code></pre></td></tr></table></div></div><p>（2）新建证书和秘钥，并为网关创建新的 Secret：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> mtls-go-example 
./generate.sh www.weather.cn  
mkdir ~/www.weather.cn <span class=o>&amp;&amp;</span> mv 1_root/ 2_intermediate/ 3_application/ 4_client/ ~/www.weather.cn/ <span class=nb>cd</span> ~/www.weather.cn 
kubectl create -n istio-system secret generic weather-credential --from-file<span class=o>=</span><span class=nv>key</span><span class=o>=</span>3_application/private/www.weather.cn.key.pem --from-file<span class=o>=</span><span class=nv>cert</span><span class=o>=</span>3_application/certs/www.weather.cn.cert.pem
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112846018.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112846018.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112846018.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112846018.png 2x" data-sizes=auto alt=image-20200514112846018 title=image-20200514112846018></p><p>（3）更新 Gateway 资源：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/gateway-sds.yaml
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112907778.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112907778.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112907778.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112907778.png 2x" data-sizes=auto alt=image-20200514112907778 title=image-20200514112907778></p><p>（4）更新 frontend 服务的 VirtualService 资源：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/vs-frontend-sds.yaml -n weather
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112926893.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112926893.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112926893.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112926893.png 2x" data-sizes=auto alt=image-20200514112926893 title=image-20200514112926893></p><p>（5）使用 CA 证书发送 HTTPS 请求，收到成功响应：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>curl -v --resolve www.weather.cn:443:10.105.28.142 --cacert 2_intermediate/certs/ca-chain.cert.pem https://www.weather.cn -o /dev/null
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112950941.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112950941.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112950941.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514112950941.png 2x" data-sizes=auto alt=image-20200514112950941 title=image-20200514112950941></p><p>（6）更新证书和秘钥：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl -n istio-system delete secret weather-credential 
<span class=nb>cd</span> mtls-go-example 
./generate.sh www.weather.cn  
mkdir ~/new.weather.cn <span class=o>&amp;&amp;</span> mv 1_root/ 2_intermediate/ 3_application/ 4_client/ ~/new.weather.cn/ kubectl create -n istio-system secret generic weather-credential --from-file<span class=o>=</span><span class=nv>key</span><span class=o>=</span>3_application/private/www.weather.cn.key.pem --from-file<span class=o>=</span>3_application/certs/www.weather.cn.cert.pem
</code></pre></td></tr></table></div></div><p>如果继续使用旧的 CA 证书发送 HTTPS 请求，期望访问失败，使用新的 CA 证书发送 HTTPS 请求，成功响应，事实相反，猜测 helm 升级失败，没有开启 sds 服务 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> ~ 
curl -v --resolve www.weather.cn:443:10.105.28.142 --cacert www.weather.cn/2_intermediate/certs/ca-chain.cert.pem https://www.weather.cn -o /dev/null 
curl -v --resolve www.weather.cn:443:10.105.28.142 --cacert new.weather.cn/2_intermediate/certs/ca-chain.cert.pem https://www.weather.cn -o /dev/null
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113014084.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113014084.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113014084.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113014084.png 2x" data-sizes=auto alt=image-20200514113014084 title=image-20200514113014084></p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113030339.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113030339.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113030339.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113030339.png 2x" data-sizes=auto alt=image-20200514113030339 title=image-20200514113030339></p><h1 id=2-访问控制>2. 访问控制</h1><p>访问控制是向应用程序注入安全构造的主要工具，对实际的代码实现没有影响。黑白名单是 Istio 实现访问控制的一种方式。</p><h2 id=21-黑名单>2.1. 黑名单</h2><p>黑名单指拒绝特定条件的调用。</p><h3 id=211-实验目标>2.1.1. 实验目标</h3><p>对 advertisement 服务创建一个黑名单，期望从 frontend 服务到 advertisement 服务的访问被拒绝。</p><h3 id=212-实验演练>2.1.2. 实验演练</h3><p>（1）启用 Istio 策略检查：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113047556.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113047556.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113047556.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113047556.png 2x" data-sizes=auto alt=image-20200514113047556 title=image-20200514113047556></p><p>（2）启用黑名单配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/blacklist.yaml -n weather
 
<span class=c1>#查看配置</span>
vim chapter-files/security/blacklist.yaml
 
apiVersion: <span class=s2>&#34;config.istio.io/v1alpha2&#34;</span>
kind: handler
metadata:
  name: denycustomerhandler
spec:
  compiledAdapter: denier
  params:
    status:
      code: <span class=m>7</span>
      message: Not allowed
---
apiVersion: <span class=s2>&#34;config.istio.io/v1alpha2&#34;</span>
kind: instance
metadata:
  name: denycustomerrequests
spec:
  compiledTemplate: checknothing
---
apiVersion: <span class=s2>&#34;config.istio.io/v1alpha2&#34;</span>
kind: rule
metadata:
  name: denycustomer
spec:
  match: destination.labels<span class=o>[</span><span class=s2>&#34;app&#34;</span><span class=o>]</span> <span class=o>==</span> <span class=s2>&#34;advertisement&#34;</span> <span class=o>&amp;&amp;</span> source.labels<span class=o>[</span><span class=s2>&#34;app&#34;</span><span class=o>]==</span><span class=s2>&#34;frontend&#34;</span>
  actions:
  - handler: denycustomerhandler
    instances: <span class=o>[</span> denycustomerrequests <span class=o>]</span>
</code></pre></td></tr></table></div></div><p>（3）进入 frontend 容器访问 advertisement 服务：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113106700.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113106700.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113106700.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113106700.png 2x" data-sizes=auto alt=image-20200514113106700 title=image-20200514113106700></p><p>（4）清除策略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl delete -f chapter-files/security/blacklist.yaml -n weather
</code></pre></td></tr></table></div></div><h2 id=22-白名单>2.2. 白名单</h2><p>白名单只允许特定属性的访问请求，拒绝不符合要求的访问请求。</p><h3 id=221-实验目标>2.2.1. 实验目标</h3><p>advertisement 服务创建一个白名单，期望只有从 frontend 服务到 advertisement 服务的访问才被允许，来自其他源头对 advertisement 服务的访问都被拒绝。</p><h3 id=222-实验演练>2.2.2. 实验演练</h3><p>（1）启用 Istio 策略检查：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113301906.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113301906.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113301906.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113301906.png 2x" data-sizes=auto alt=image-20200514113301906 title=image-20200514113301906></p><p>（2）启用白名单配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/whitelist.yaml -n weather
 
<span class=c1>#查看配置</span>
vim chapter-files/security/whitelist.yaml
 
apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: advertisementwhitelist
spec:
  compiledAdapter: listchecker
  params:
    overrides: <span class=o>[</span><span class=s2>&#34;frontend&#34;</span><span class=o>]</span>
    blacklist: <span class=nb>false</span>
---
apiVersion: config.istio.io/v1alpha2
kind: instance
metadata:
  name: advertisementsource
spec:
  compiledTemplate: listentry
  params:
    value: source.labels<span class=o>[</span><span class=s2>&#34;app&#34;</span><span class=o>]</span>
---
apiVersion: config.istio.io/v1alpha2
kind: rule
metadata:
  name: check
spec:
  match: destination.labels<span class=o>[</span><span class=s2>&#34;app&#34;</span><span class=o>]</span> <span class=o>==</span> <span class=s2>&#34;advertisement&#34;</span>
  actions:
  - handler: advertisementwhitelist
    instances:
    - advertisementsource
</code></pre></td></tr></table></div></div><p>（3）浏览器中访问前台页面，可以正常看到 advertisement 服务信息，说明 frontend 服务能正常访问 advertisement 服务。</p><p>进入 forecast 容器，访问 advertisement 服务，提示访问源不在白名单，访问被拒绝。</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113135097.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113135097.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113135097.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113135097.png 2x" data-sizes=auto alt=image-20200514113135097 title=image-20200514113135097></p><p>（4）清除策略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl delete -f chapter-files/security/whitelist.yaml -n weather
</code></pre></td></tr></table></div></div><h1 id=3-认证>3. 认证</h1><p>Istio 通过双向 TLS 方式提供了从服务到服务的传输认证。</p><h2 id=31-实验目标>3.1. 实验目标</h2><p>为 advertisement 服务设置认证策略和目的地规则，使得只有在网格内有 Sidecar 的服务才能访问 advertisement 服务，其他来源的访问都被拒绝。</p><h2 id=32-实验演练>3.2. 实验演练</h2><p>（1）Kiali 容器（未注入 sidecar 的任意容器）中对 advertisement 服务发起请求，返回成功：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113434493.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113434493.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113434493.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113434493.png 2x" data-sizes=auto alt=image-20200514113434493 title=image-20200514113434493></p><p>（2）为 advertisement 服务启用双向 TLS 认证：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/advertisement-authentication-policy.yaml -n weather
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113501300.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113501300.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113501300.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113501300.png 2x" data-sizes=auto alt=image-20200514113501300 title=image-20200514113501300></p><p>此时 advertisement 服务仅接收使用 TLS 的加密请求，如果在 Kiali 容器中再次直接对 advertisement 服务发起请求，则由于请求没有加密，返回失败：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113518838.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113518838.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113518838.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113518838.png 2x" data-sizes=auto alt=image-20200514113518838 title=image-20200514113518838></p><p>（3）设置 advertisement 服务的 DestinationRule，指定访问 advertisement 服务的客户端需要使用双向 TLS：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/dr-advertisement-tls.yaml -n weather
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113541472.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113541472.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113541472.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113541472.png 2x" data-sizes=auto alt=image-20200514113541472 title=image-20200514113541472></p><p>（4）进入 frontend 容器，对 advertisement 服务发起请求，由于 frontend 服务的 Proxy 会对请求加密后发出，所以返回成功。</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113605972.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113605972.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113605972.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113605972.png 2x" data-sizes=auto alt=image-20200514113605972 title=image-20200514113605972></p><p>从 Kiali 实时流量监控进一步确认，有流量从 frontend 服务发往 advertisement 服务，小锁图标表示流量经过加密。</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113619088.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113619088.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113619088.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113619088.png 2x" data-sizes=auto alt=image-20200514113619088 title=image-20200514113619088></p><h1 id=4-授权>4. 授权</h1><p>Istio 使用基于角色的访问权限控制（RBAC 模型）来进行授权控制。</p><h2 id=41-命名空间级别的访问控制>4.1. 命名空间级别的访问控制</h2><p>Istio 能够轻松实现命名空间级别的访问控制，即对某个命名空间下的所有服务或部分服务设置策略，允许被其他命名空间的服务访问。</p><h3 id=411-实验目标>4.1.1. 实验目标</h3><p>只允许 istio-system 命名空间下的服务（如 ingressgateway）访问 weather 命名空间下的服务，其他命名空间下的服务不能访问 weather 命名空间下的服务。</p><h3 id=412-实验演练>4.1.2. 实验演练</h3><p>（1）为 weather 设置命名空间级别的认证策略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/weather-authentication-policy.yaml
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113654395.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113654395.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113654395.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113654395.png 2x" data-sizes=auto alt=image-20200514113654395 title=image-20200514113654395></p><p>这时在浏览器中访问前台页面，显示 “upstream connect error or disconnect/reset before headers. reset reason: connection termination”，原因是认证策略要求对 weather 命名空间下的服务访问</p><p>必须是加密的请求。</p><p>（2）为 weather 命名空间下的 frontend、advertisement、forecast 和 recommendation 等服务设置 DestinationRule 的 TLS 策略，则请求端的 Proxy 会对这些目标服务的请求进行加密：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/dr-all-tls.yaml -n weather
</code></pre></td></tr></table></div></div><p>以 frontend 服务为例，查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113716782.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113716782.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113716782.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113716782.png 2x" data-sizes=auto alt=image-20200514113716782 title=image-20200514113716782></p><p>再次在浏览器中访问前台页面，查询天气，返回正常。</p><p>（3）启用 Istio 对 weather 命名空间下所有服务的访问控制：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/weather-rbac-config.yaml
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113732119.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113732119.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113732119.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113732119.png 2x" data-sizes=auto alt=image-20200514113732119 title=image-20200514113732119></p><p>浏览器访问前台服务，看到 &ldquo;RBAC: access denied&rdquo;，原因是 Istio 访问控制默认采用拒绝策略，这就要求必须显示声明授权策略才能成功访问到服务。</p><p>（4）配置授权策略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/weather-authorization.yaml -n weather
</code></pre></td></tr></table></div></div><p>查看配置：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113757750.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113757750.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113757750.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113757750.png 2x" data-sizes=auto alt=image-20200514113757750 title=image-20200514113757750></p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113815104.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113815104.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113815104.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113815104.png 2x" data-sizes=auto alt=image-20200514113815104 title=image-20200514113815104></p><p>完成配置后等待几秒，浏览器再次访问前台服务，一切正常。因为在浏览器访问时通过 istio-system 下的 ingressgateway 入口访问 weather 命名空间下的服务，根据授权策略，这是被允许的。</p><p>进入 default 命名空间下的 sleep 服务，对 weather 命名空间下的 advertisement 服务发起请求，根据授权策略，来自其他命名空间的访问都被拒绝。</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113835342.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113835342.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113835342.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113835342.png 2x" data-sizes=auto alt=image-20200514113835342 title=image-20200514113835342></p><h2 id=42-服务级别的访问控制>4.2. 服务级别的访问控制</h2><p>除了在命名空间范围内控制访问，Istio 还可以精确地对单个服务进行访问控制。</p><h3 id=421-实验目标>4.2.1. 实验目标</h3><p>Istio 在服务级别设置访问策略，依次开放对 frontend 服务和 advertisement 服务的访问权限。</p><h3 id=422-实验演练>4.2.2. 实验演练</h3><p>（1）参照上节设置命名空间级别的认证策略，设置 DestinationRule 的 TLS 策略，启用 Istio 对 weather 命名空间级别的访问控制。</p><p>（2）开放访问 frontend 服务的权限：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f chapter-files/security/frontend-authorization.yaml
</code></pre></td></tr></table></div></div><p>查看授权策略：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113852895.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113852895.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113852895.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113852895.png 2x" data-sizes=auto alt=image-20200514113852895 title=image-20200514113852895></p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113913090.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113913090.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113913090.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113913090.png 2x" data-sizes=auto alt=image-20200514113913090 title=image-20200514113913090></p><p>等待几秒后，用浏览器可以正常访问前台服务，但不能访问广告服务。广告服务接口调用返回 &ldquo;RBAC: access denied&rdquo;。</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113958009.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113958009.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113958009.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514113958009.png 2x" data-sizes=auto alt=image-20200514113958009 title=image-20200514113958009></p><p>（3）开放访问 advertisement 服务的权限：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl -n weather apply -f chapter-files/security/advertisement-authorization.yaml
</code></pre></td></tr></table></div></div><p>查看授权策略：</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114019630.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114019630.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114019630.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114019630.png 2x" data-sizes=auto alt=image-20200514114019630 title=image-20200514114019630></p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114038026.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114038026.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114038026.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114038026.png 2x" data-sizes=auto alt=image-20200514114038026 title=image-20200514114038026></p><p>等待几秒后，在浏览器再次访问前台服务和广告服务，均正常显示。</p><p><img class=lazyload src=/svg/loading/small.min.svg data-src=https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114108195.png data-srcset="https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114108195.png, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114108195.png 1.5x, https://cdn.jsdelivr.net/gh/garroshh/figurebed/img/image-20200514114108195.png 2x" data-sizes=auto alt=image-20200514114108195 title=image-20200514114108195></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-05-14</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/istio/>Istio</a>,&nbsp;<a href=/tags/%E5%AE%9E%E9%AA%8C/>实验</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/%E8%87%AA%E5%8A%A8%E5%8C%96%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/ class=prev rel=prev title=自动化灰度发布><i class="fas fa-angle-left fa-fw"></i>自动化灰度发布</a>
<a href=/%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/ class=next rel=next title=多集群管理>多集群管理<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=gitalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/gitalk/gitalk></a>Gitalk</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.71.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.9"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=garroshh.me target=_blank>garroshh</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"gitalk":{"admin":["garroshh"],"clientID":"765aeb40ecd9058c4ab8","clientSecret":"824af1ecb35c665e4d7fb379211bb748841e96a1","id":"2020-05-14T11:17:30+08:00","owner":"garroshh","repo":"garroshh.github.io","title":"服务保护"}},"data":{"id-1":"Garroshh's Blog","id-2":"Garroshh's Blog"},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>